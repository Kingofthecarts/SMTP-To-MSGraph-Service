CRITICAL FIX: Configuration File Protection
============================================
Date: October 1, 2025
Version: 1.1.2

PROBLEM
-------
The smtp-config.json file was being overwritten during builds, causing loss
of user configuration including encrypted credentials.

ROOT CAUSE
----------
There was a config/smtp-config.json file in the source directory that could
potentially be copied to the output directory during builds, overwriting the
user's configured version.

THE FIX
-------

1. SOURCE FILE RENAMED
   ‚úÖ Renamed: config/smtp-config.json ‚Üí config/smtp-config.template.json
   - Template is now clearly marked as reference only
   - Never copied to output directory
   - Kept in source control for documentation

2. BUILD CONFIGURATION UPDATED (.csproj)
   ‚úÖ Added explicit exclusions:
   ```xml
   <None Include="config\smtp-config.template.json">
     <CopyToOutputDirectory>Never</CopyToOutputDirectory>
   </None>
   ```
   - Template explicitly marked as "Never" copy
   - All config/** files excluded from build

3. CODE PROTECTION ENHANCED (ConfigurationManager.cs)
   ‚úÖ Added multiple layers of protection:
   
   a) Only Creates If Missing:
      - Checks File.Exists() before creating
      - Never overwrites existing config
      
   b) Automatic Backup System:
      - Creates .backup file before every save
      - Logs backup creation
      - Allows recovery from errors
      
   c) Enhanced Logging:
      - "Configuration file not found - creating new"
      - "Configuration loaded successfully"
      - "Configuration backup created"
      - "Configuration saved successfully"
      - "ERROR: Could not load config, but file exists. Not overwriting!"
      
   d) Error Handling:
      - If config exists but can't load: DON'T overwrite
      - Preserve corrupt file for manual recovery
      - User can restore from .backup

4. SOURCE CONTROL PROTECTION (.gitignore)
   ‚úÖ Added config/.gitignore:
   ```
   smtp-config.json      # Exclude actual config
   *.backup              # Exclude backups
   !smtp-config.template.json  # Keep template
   ```

5. DOCUMENTATION (config/README.md)
   ‚úÖ Comprehensive guide explaining:
   - How the protection system works
   - Template vs actual config
   - Backup system
   - Troubleshooting
   - Security notes

TESTING CHECKLIST
-----------------

‚úÖ Test 1: First Run (No Config)
   1. Delete bin/config/smtp-config.json if it exists
   2. Run application
   3. Should see: "Configuration file not found - creating new configuration"
   4. Config created with defaults
   5. Configure and save settings
   
‚úÖ Test 2: Existing Config Preserved
   1. Configure application with real settings
   2. Save configuration
   3. Rebuild project (Debug or Release)
   4. Run application
   5. Should see: "Configuration loaded successfully"
   6. Verify your settings are intact (check port, credentials, etc.)
   
‚úÖ Test 3: Backup System
   1. Configure application
   2. Click Save
   3. Check config/smtp-config.json.backup exists
   4. Backup should have previous settings
   
‚úÖ Test 4: Publish Profile
   1. Use Publish in Visual Studio
   2. Copy to C:\Build or other location
   3. Verify no config copied from source
   4. Run published app
   5. Should create new config in published location
   
‚úÖ Test 5: Source Control
   1. Check git status
   2. smtp-config.json should not appear (ignored)
   3. Only smtp-config.template.json in source
   
‚úÖ Test 6: Manual Config Edit
   1. Edit smtp-config.json manually
   2. Run application
   3. Should load your manual changes
   4. Save through GUI
   5. Creates backup of your manual version

WHAT'S PROTECTED NOW
--------------------

‚úì Build operations (Debug/Release)
‚úì Publish operations (any profile)
‚úì Clean and rebuild
‚úì Source control commits
‚úì Accidental overwrites in code
‚úì Save errors (via backup)
‚úì Corrupt config files (preserved for recovery)

FILE STRUCTURE
--------------

Source Directory (Project):
  config/
    ‚îú‚îÄ‚îÄ smtp-config.template.json  (in source control, never copied)
    ‚îú‚îÄ‚îÄ README.md                   (documentation)
    ‚îî‚îÄ‚îÄ .gitignore                  (protects actual config)

Output Directory (bin/Debug or bin/Release):
  config/
    ‚îú‚îÄ‚îÄ smtp-config.json           (your actual config - PROTECTED)
    ‚îî‚îÄ‚îÄ smtp-config.json.backup    (automatic backup)

Published Directory (C:\Build or service location):
  config/
    ‚îú‚îÄ‚îÄ smtp-config.json           (created on first run)
    ‚îî‚îÄ‚îÄ smtp-config.json.backup    (created after first save)

RECOVERY PROCEDURE
------------------

If config is lost or corrupted:

1. Check for backup:
   - Look for smtp-config.json.backup
   - Copy to smtp-config.json
   - Restart application

2. If no backup:
   - Delete smtp-config.json
   - Run application (creates new default)
   - Reconfigure through GUI

3. If you have old backup elsewhere:
   - Copy your backup to config/smtp-config.json
   - Restart application
   - Should load your settings

CONSOLE OUTPUT EXAMPLES
-----------------------

First Run:
```
Configuration file not found at: C:\path\to\config\smtp-config.json
Creating new configuration with defaults...
New configuration created successfully.
Please configure your SMTP and MS Graph settings.
```

Normal Run:
```
Loading configuration from: C:\path\to\config\smtp-config.json
Configuration loaded successfully.
```

Saving Config:
```
Configuration backup created: C:\path\to\config\smtp-config.json.backup
Configuration saved successfully.
```

Error But Protected:
```
ERROR loading configuration: Invalid JSON format
WARNING: Could not load config, but file exists. Not overwriting!
```

VERIFICATION
------------

To verify the fix is working:

1. Configure your application completely
2. Note your settings (port, credentials, etc.)
3. Close application
4. Rebuild in Visual Studio
5. Run application again
6. Your settings should be exactly as you left them
7. Console should say "Configuration loaded successfully"

If your config was overwritten:
- Check if you have custom build scripts
- Verify .csproj changes were saved
- Check for post-build events copying files
- Make sure you're running the built version, not the source

BACKWARDS COMPATIBILITY
-----------------------

‚úì Existing installations keep working
‚úì No breaking changes
‚úì Old configs are loaded normally
‚úì All features still work

MAINTENANCE NOTES
-----------------

For developers:
- Never commit smtp-config.json to source control
- Always use smtp-config.template.json for reference
- Keep template updated with new settings
- Document any new configuration fields

For users:
- Your config is now safe from builds
- Always use the GUI to save config (creates backup)
- Keep external backup of credentials separately
- Config is machine-specific due to DPAPI encryption

SUPPORT
-------

If config still gets overwritten:
1. Verify you have version 1.1.2 or later
2. Check .csproj file has the protection rules
3. Look for custom build scripts copying files
4. Check post-build events in Visual Studio
5. Report issue with details of build process

This fix ensures your configuration is NEVER lost during builds! üõ°Ô∏è
