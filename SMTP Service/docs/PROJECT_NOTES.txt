================================================================================
SMTP TO MS GRAPH RELAY SERVICE - PROJECT NOTES
================================================================================
Last Updated: 2025-10-01

PROJECT OVERVIEW
================
Windows service that acts as an SMTP relay, receiving emails via SMTP protocol
on port 25 and forwarding them through Microsoft Graph API to Microsoft 365.

REQUIREMENTS
============
• Windows 10/11 or Windows Server 2016+
• .NET 9 Desktop Runtime (REQUIRED for end users)
  Download: https://dotnet.microsoft.com/download/dotnet/9.0
  - Select "Download .NET Desktop Runtime 9.0.x"
  - Install Microsoft.WindowsDesktop.App 9.0.x
  - Verify: dotnet --list-runtimes
• Administrator privileges (for port 25)
• Microsoft 365 subscription
• Azure AD App Registration with Mail.Send permission

TECHNOLOGY STACK
================
• Framework: .NET 9.0
• Project Type: Worker Service
• Language: C#
• Platform: Windows
• UI Framework: Windows Forms

REQUIRED NUGET PACKAGES
=======================
✓ Microsoft.Graph - MS Graph API client
✓ Azure.Identity - Authentication for MS Graph
✓ Serilog.Extensions.Hosting - Structured logging framework
✓ Serilog.Sinks.File - Log to files
✓ Serilog.Sinks.Console - Log to console
✓ Microsoft.Extensions.Hosting.WindowsServices - Run as Windows Service
✓ System.Security.Cryptography.ProtectedData - Encrypt sensitive config data

NOTE: We are NOT using SmtpServer package - built custom SMTP server from scratch!


ARCHITECTURE COMPONENTS
=======================

1. SMTP SERVER (Custom Built - No External Library)
   - TCP listener on port 25
   - Full SMTP protocol implementation:
     * HELO/EHLO - Initial handshake
     * AUTH LOGIN/PLAIN - Authentication with Base64 encoding
     * MAIL FROM - Sender address extraction
     * RCPT TO - Recipient address extraction  
     * DATA - Email content with proper termination (.)
     * RSET - Reset transaction
     * NOOP - No operation
     * QUIT - Close connection
   - Validate SMTP credentials against configuration
   - Parse email headers and body
   - Support for multiple recipients
   - Stores last parsed email to avoid double-parsing bug

2. MS GRAPH EMAIL SERVICE
   - Authenticate with OAuth (Client Credentials flow)
   - ClientSecretCredential for app-only authentication
   - Send emails via Graph API (/users/{user}/sendMail)
   - Enhanced error detection:
     * AADSTS7000215 - Expired client secret
     * AADSTS90002 - Invalid tenant ID
     * AADSTS700016 - Invalid client ID
     * unauthorized_client - Missing permissions
   - Test connection capability
   - Detailed logging of all operations

3. EMAIL QUEUE MANAGER
   - ConcurrentQueue for thread-safe operations
   - Retry logic with configurable attempts and delays
   - Track email status (Pending, Processing, Sent, Failed, Retrying)
   - Automatic cleanup of old items (7+ days)
   - Statistics tracking by status
   - Recent items history (last 100)

4. CONFIGURATION MANAGER
   - JSON-based configuration (config/smtp-config.json)
   - DPAPI encryption for sensitive data (Windows Data Protection API)
   - Automatic encryption on save, decryption on load
   - Stored in config subdirectory of application directory (portable)
   - Prefix encrypted values with "ENC:" for identification

5. LOGGING SYSTEM (Serilog)
   - Structured logging with levels (Debug, Info, Warning, Error)
   - Rolling daily log files in logs/ directory
   - Console output with timestamps
   - Logs created in application directory
   - All SMTP commands and responses logged
   - All MS Graph API calls logged with details
   - Authentication attempts tracked

6. SYSTEM TRAY GUI (Windows Forms)
   - NotifyIcon for system tray presence
   - Tabbed configuration interface:
     * SMTP Settings - Port, authentication, users
     * MS Graph Settings - Tenant ID, Client ID, Secret, Sender
     * Queue Settings - Retry attempts and delays
     * Test Email - Send test emails directly via Graph
   - Context menu features:
     * Configuration
     * Service Status
     * View Logs
     * Show File Locations (new!)
     * Start/Stop/Restart Service
   - Test MS Graph connection button
   - Send test email functionality
   - View application paths


RUNNING MODES
=============

THREE OPERATION MODES - NOW CONFIGURABLE:

The application can run in three different modes. You can now set your preferred
default mode in the configuration, so it always starts the way you want!

1. SERVICE MODE (Default - RunMode 0)
   Command: SMTP Service.exe (no arguments)
   - Runs as console application or Windows Service
   - Console window shows all logs
   - No system tray icon
   - Best for: Debugging, watching real-time logs
   
2. CONSOLE + TRAY MODE (RunMode 1 - Best of Both Worlds!)
   Command: SMTP Service.exe --console (or set RunMode=1 in config)
   - Console window with all logs visible
   - System tray icon for quick configuration access
   - Best for: Development, testing, monitoring
   
3. TRAY MODE (RunMode 2)
   Command: SMTP Service.exe --tray (or set RunMode=2 in config)
   - System tray icon only
   - No console window
   - Double-click tray icon for configuration
   - Best for: Production use, minimal interface

★ NEW: CONFIGURE DEFAULT RUN MODE
You can now set the default run mode in the Application Settings tab of the
configuration GUI. The application will automatically start in your chosen mode
without needing command line arguments. Command line arguments will still
override the configured setting when provided.


CONFIGURATION (JSON FORMAT)
===========================
Configuration stored in config/smtp-config.json with encrypted sensitive fields:

{
  "ApplicationSettings": {
    "RunMode": 0
  },
  "SmtpSettings": {
    "Port": 25,
    "RequireAuthentication": false,
    "Credentials": [
      {
        "Username": "user1",
        "Password": "ENC:base64encryptedvalue"
      }
    ],
    "MaxMessageSizeKb": 10240,
    "EnableTls": false
  },
  "GraphSettings": {
    "TenantId": "ENC:base64encryptedvalue",
    "ClientId": "ENC:base64encryptedvalue", 
    "ClientSecret": "ENC:base64encryptedvalue",
    "SenderEmail": "noreply@yourdomain.com"
  },
  "QueueSettings": {
    "MaxRetryAttempts": 3,
    "RetryDelayMinutes": 5,
    "MaxQueueSize": 1000
  },
  "LogSettings": {
    "LogLevel": "Information",
    "LogFilePath": "C:\\Full\\Path\\To\\logs\\smtp-relay.log",
    "RollingInterval": "Day"
  }
}


FEATURES IMPLEMENTED
====================
✓ Custom SMTP server (no external library)
✓ Full SMTP protocol implementation
✓ MS Graph API integration for sending
✓ Email queue with automatic retry logic
✓ Encrypted configuration storage (DPAPI)
✓ Comprehensive logging (Serilog)
✓ System tray GUI with tabbed interface
✓ Three operation modes (Service, Console+Tray, Tray Only)
✓ Configurable default run mode (NEW!)
✓ Service control from tray (Start/Stop/Restart)
✓ View logs functionality
✓ Show file locations feature
✓ Test MS Graph connection
✓ Send test emails directly via Graph
✓ Enhanced error messages with specific Azure AD error codes
✓ Statistics and monitoring
✓ Health checks
✓ Works as Windows Service
✓ Authentication required option
✓ Multiple SMTP users support


FEATURES NOT INCLUDED
======================
✗ User mapping (sends on behalf of tenant, not individual users)
✗ TLS/STARTTLS (could be added)
✗ Email attachments (Graph API supports, not implemented)
✗ SMTP over SSL


SECURITY FEATURES
=================
• DPAPI encryption for passwords and secrets
• Encrypted configuration file
• SMTP authentication (configurable)
• Secure OAuth token handling
• All authentication attempts logged
• Failed login tracking
• Client secret expiration detection


ACTUAL FILE STRUCTURE (AS BUILT)
=================================
SMTP Service/
├── Program.cs (Entry point with 3 modes)
├── Worker.cs (Background service host)
├── TrayApp.cs.bak (Backup - not used)
├── Services/
│   ├── SmtpServerService.cs (TCP listener + SMTP server)
│   ├── GraphEmailService.cs (MS Graph integration)
│   └── QueueProcessorService.cs (Background queue processor)
├── Models/
│   ├── AppConfig.cs (All configuration models)
│   ├── EmailMessage.cs (Email structure)
│   └── EmailQueueItem.cs (Queue item with retry tracking)
├── Managers/
│   ├── ConfigurationManager.cs (JSON config with encryption)
│   ├── QueueManager.cs (Queue management)
│   └── SmtpProtocolHandler.cs (SMTP command handling)
├── UI/
│   ├── TrayApplicationContext.cs (System tray)
│   └── ConfigurationForm.cs (Tabbed settings GUI)
├── appsettings.json (App settings)
├── install-service.bat (Installation helper)
├── config/
│   └── smtp-config.json (Runtime config - auto-created)
├── MESSAGE_FLOW.txt (Architecture diagram)
├── PROJECT_NOTES.txt (This file)
├── PROJECT_COMPLETE.txt (Completion summary)
├── SETUP_CHECKLIST.txt (Setup guide)
├── README.md (User documentation)
└── logs/ (Log directory - auto-created)


DEVELOPMENT NOTES
=================
• Built with .NET 9.0 Worker Service template
• Uses async/await throughout
• Dependency injection for all services
• Thread-safe queue operations
• Graceful shutdown handling
• Portable - all files stored relative to exe location


DEPLOYMENT NOTES
================
• Publish as single-file executable (recommended)
• Self-contained option includes .NET runtime (~70MB)
• Framework-dependent option requires .NET 9 installed (~10MB)
• Install as Windows Service using install-service.bat
• Run system tray app with --tray for configuration
• Port 25 requires administrator privileges
• Windows Firewall rule required for remote connections


MS GRAPH SETUP REQUIREMENTS
============================
1. Register application in Azure AD
2. Configure API permissions:
   - Mail.Send (Application permission - NOT delegated)
3. Grant admin consent
4. Create client secret (note expiration date!)
5. Copy: Tenant ID, Client ID (Application ID), Client Secret Value


SMTP PROTOCOL IMPLEMENTATION DETAILS
====================================
Commands Implemented:
• 220 - Service ready greeting
• HELO - Basic handshake
• EHLO - Extended handshake with capabilities
• AUTH LOGIN - Base64 encoded authentication
• AUTH PLAIN - Plain authentication
• MAIL FROM - Sender address (extracts from <>)
• RCPT TO - Recipient address (supports multiple)
• DATA - Email content (ends with \r\n.\r\n)
• RSET - Reset transaction
• NOOP - No operation
• QUIT - Close connection (221 Goodbye)
• 250 - Success responses
• 334 - AUTH continuation
• 235 - AUTH success
• 354 - Start mail input
• 500 - Unrecognized command
• 501 - Syntax error
• 503 - Bad command sequence
• 530 - Authentication required

Email Parsing:
• Extracts From from MAIL FROM command
• Extracts To from RCPT TO commands (supports multiple)
• Parses Subject from DATA headers
• Parses Cc from DATA headers
• Detects Content-Type for HTML detection
• Handles both \r\n\r\n and \n\n header/body separation


KNOWN ISSUES FIXED
==================
✓ Double-parsing email bug (was calling ParseEmailData twice)
✓ Variable name conflicts in Program.cs (tray mode vs service mode)
✓ Nullable warnings in UI components
✓ AddSerilog missing in ConfigurationForm
✓ Log directory not being created
✓ Configuration file not portable (now uses BaseDirectory)
✓ Client secret expiration not clearly logged (now detected)


TESTING COMPLETED
=================
✓ SMTP connection via Telnet
✓ SMTP connection via PuTTY (Raw mode)
✓ MS Graph authentication
✓ MS Graph email sending
✓ Email queue and retry logic
✓ Configuration save/load with encryption
✓ System tray functionality
✓ All three operation modes
✓ Test email feature
✓ Service installation
✓ Log file creation and viewing


COMMON AZURE AD ERROR CODES
============================
Now detected and logged with specific messages:

• AADSTS7000215 - Client secret is invalid or expired
  Fix: Create new client secret in Azure Portal

• AADSTS90002 - Tenant ID not found
  Fix: Verify Tenant ID from Azure Portal → Azure AD → Overview

• AADSTS700016 - Application (Client) ID not found
  Fix: Verify Client ID from App Registrations → Overview

• unauthorized_client - App not authorized for Mail.Send
  Fix: Add Mail.Send permission and grant admin consent


PERFORMANCE CHARACTERISTICS
============================
• Handles multiple concurrent SMTP connections
• Async/await for non-blocking I/O
• In-memory queue (fast)
• ConcurrentQueue (thread-safe)
• Configurable queue size (default 1000)
• Automatic retry with exponential backoff
• Rolling logs prevent disk space issues
• Automatic cleanup of old queue items


BUILD AND PUBLISH
=================
Development Build:
  • Build → Build Solution (Ctrl+Shift+B)
  • Output: bin\Debug\net9.0-windows\

Release Build:
  • Change to Release configuration
  • Build → Build Solution
  • Output: bin\Release\net9.0-windows\

Publish (Single EXE):
  • Right-click project → Publish
  • Target: Folder
  • Configuration: Release
  • Target Framework: net9.0-windows
  • Deployment: Self-contained
  • Target Runtime: win-x64
  • ✓ Produce single file
  • ✓ Enable ReadyToRun
  
Command Line Publish:
  dotnet publish -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true


VERSION HISTORY
===============
v1.1.0 - Run Mode Configuration Update
  • Added configurable default run mode
  • Application Settings tab in configuration GUI
  • RunMode setting in smtp-config.json
  • Automatic mode selection on startup
  • Command line arguments still override config
  • Better user experience - no need to remember arguments

v1.0.0 - Initial Release
  • Custom SMTP server implementation
  • MS Graph integration
  • System tray GUI
  • Three operation modes
  • Test email functionality
  • Enhanced error detection
  • Complete logging system


FUTURE ENHANCEMENTS (Optional)
===============================
• Email attachments support
• TLS/STARTTLS for SMTP
• Email size limits and validation
• Domain whitelisting/blacklisting
• Multiple sender accounts
• Real-time statistics dashboard
• Web-based configuration interface
• Email archiving
• SPF/DKIM validation
• Rate limiting per user/IP
• Database queue persistence
• Advanced monitoring/alerting


CREDITS
=======
Developed with assistance from Claude (Anthropic)
SMTP Protocol: RFC 5321
Microsoft Graph API: graph.microsoft.com
Serilog: serilog.net

================================================================================
END OF PROJECT NOTES
================================================================================
