================================================================================
SMTP TO MS GRAPH RELAY - SETUP CHECKLIST
================================================================================

□ STEP 0: INSTALL .NET 9 DESKTOP RUNTIME (REQUIRED!)
========================================================
□ Download .NET 9 Desktop Runtime from:
  https://dotnet.microsoft.com/download/dotnet/9.0
  
□ Click "Download .NET Desktop Runtime 9.0.x"
□ Choose Windows x64 or x86 (match your system architecture)
□ Run the installer
□ Restart computer if prompted
□ Verify installation:
  Open Command Prompt and run: dotnet --list-runtimes
  You should see: Microsoft.WindowsDesktop.App 9.0.x
  
NOTE: The application WILL NOT RUN without this runtime installed!


□ STEP 1: INSTALL NUGET PACKAGES (FOR DEVELOPERS)
================================
Open Visual Studio > Right-click project > Manage NuGet Packages > Browse

Install these packages:
□ Microsoft.Graph
□ Azure.Identity
□ Serilog.Extensions.Hosting
□ Serilog.Sinks.File
□ Serilog.Sinks.Console
□ Microsoft.Extensions.Hosting.WindowsServices
□ System.Security.Cryptography.ProtectedData


□ STEP 2: AZURE AD APP REGISTRATION
===================================
□ Go to https://portal.azure.com
□ Navigate to Azure Active Directory > App registrations
□ Click "New registration"
□ Enter name: "SMTP Graph Relay"
□ Click "Register"
□ Copy the Application (client) ID: _____________________________
□ Copy the Directory (tenant) ID: _____________________________
□ Go to "Certificates & secrets"
□ Click "New client secret"
□ Add description, select expiration
□ Copy the Secret Value: _____________________________
  (IMPORTANT: You won't see this again!)
□ Go to "API permissions"
□ Click "Add a permission"
□ Select "Microsoft Graph" > "Application permissions"
□ Search for and add: Mail.Send
□ Click "Grant admin consent for [your tenant]"
□ Verify the status shows "Granted"


□ STEP 3: BUILD THE PROJECT
===========================
□ Open solution in Visual Studio
□ Ensure all NuGet packages are restored
□ Build > Build Solution (or press Ctrl+Shift+B)
□ Verify no build errors
□ Check output: bin\Debug\net9.0\ or bin\Release\net9.0\


□ STEP 4: CONFIGURE THE SERVICE
===============================
□ Navigate to the build output folder
□ Run "SMTP Service.exe" --tray (or just double-click it)
□ System tray icon should appear
□ Double-click tray icon to open configuration
□ Fill in SMTP Settings:
  □ Port: 25 (or your preferred port)
  □ Require Authentication: ✓ (recommended)
  □ Add users with username and password
□ Fill in MS Graph Settings:
  □ Tenant ID: (from Azure AD)
  □ Client ID: (from Azure AD)
  □ Client Secret: (from Azure AD)
  □ Sender Email: (valid email in your M365 tenant)
□ Configure Application Settings:
  □ Default Run Mode: Choose how you want the app to start
    • Service/Console Mode (0) - Shows console with logs
    • Console with Tray (1) - Console + tray icon (best for monitoring)
    • Tray Only (2) - Minimal tray-only interface
  □ Max Retry Attempts: (default 3)
  □ Retry Delay: (default 5 minutes)
□ Click "Test Connection" to verify Graph settings
□ Click "Save"


□ STEP 5: INSTALL AS WINDOWS SERVICE
====================================
Choose ONE method:

METHOD A - Using install-service.bat (Easiest):
□ Right-click install-service.bat
□ Select "Run as Administrator"
□ Choose option 1 to install
□ Choose option 9 to add firewall rule
□ Choose option 2 to start service

METHOD B - Using Command Line:
□ Open Command Prompt as Administrator
□ Navigate to the build folder
□ Run: sc create "SMTP to Graph Relay" binPath= "C:\Full\Path\To\SMTP Service.exe" start= auto
□ Run: sc start "SMTP to Graph Relay"
□ Run: netsh advfirewall firewall add rule name="SMTP Relay" dir=in action=allow protocol=TCP localport=25


□ STEP 6: VERIFY SERVICE IS RUNNING
===================================
□ Open Services (services.msc)
□ Find "SMTP to Graph Relay"
□ Status should be "Running"
□ Or use: sc query "SMTP to Graph Relay"
□ Or use tray app: Right-click > Service Status


□ STEP 7: TEST SMTP CONNECTION
==============================
□ Open Command Prompt
□ Test connectivity: telnet localhost 25
  (If telnet not available: dism /online /Enable-Feature /FeatureName:TelnetClient)
□ You should see: 220 [hostname] SMTP Ready
□ Type: QUIT

Or test with PowerShell:
□ Send-MailMessage -SmtpServer localhost -Port 25 `
    -From "test@yourdomain.com" `
    -To "recipient@example.com" `
    -Subject "Test" `
    -Body "Test message" `
    -Credential (Get-Credential)


□ STEP 8: VERIFY EMAIL SENDING
==============================
□ Send a test email through SMTP
□ Check logs in: [application folder]\logs\
□ Look for "Email queued" message
□ Look for "Email sent via Graph API" message
□ Check recipient's inbox
□ If failed, check error messages in logs


□ STEP 9: MONITORING
====================
□ Check logs regularly: [application folder]\logs\
□ Use tray app to view logs: Right-click > View Logs
□ Monitor Windows Event Viewer for service errors
□ Check service status periodically


TROUBLESHOOTING CHECKLIST
=========================
If emails aren't sending:

□ Check service is running: sc query "SMTP to Graph Relay"
□ Check logs for errors
□ Verify Graph credentials in configuration
□ Test Graph connection from config GUI
□ Verify API permissions in Azure AD (Mail.Send + Admin consent)
□ Verify sender email exists in your M365 tenant
□ Check network connectivity to graph.microsoft.com
□ Verify SMTP authentication is working (check logs)

If SMTP clients can't connect:

□ Verify service is running
□ Check firewall allows port 25
□ Test locally first (localhost)
□ Check logs for connection attempts
□ Verify port 25 is not in use: netstat -an | find "25"
□ Try different SMTP client to isolate issue


SECURITY RECOMMENDATIONS
========================
□ Use strong passwords for SMTP users
□ Regularly rotate Azure AD client secret
□ Monitor logs for unauthorized access
□ Keep the application updated
□ Limit SMTP user accounts to necessary users only
□ Consider implementing IP whitelisting
□ Use firewall to restrict access to port 25
□ Back up configuration file regularly


MAINTENANCE SCHEDULE
===================
□ Weekly: Review logs for errors or warnings
□ Monthly: Check service status and restart if needed
□ Quarterly: Rotate Azure AD client secret
□ As needed: Update SMTP user passwords
□ Before expiry: Renew Azure AD client secret


NOTES AND CUSTOMIZATION
=======================
Configuration file location: [app folder]\config\smtp-config.json
Logs location: [app folder]\logs\

The smtp-config.json file now includes an "ApplicationSettings" section:
  "ApplicationSettings": {
    "RunMode": 0    // 0=Service/Console, 1=Console+Tray, 2=Tray Only
  }

Custom settings you can modify:
□ Run mode (default 0 - Service/Console)
□ Port number (default 25)
□ Max retry attempts (default 3)
□ Retry delay (default 5 minutes)
□ Max message size (default 10MB)
□ Log level (default: Information)

Remember:
- Restart service after configuration changes
- Sensitive data is encrypted in config file
- Service runs under SYSTEM account by default


COMPLETION
==========
□ Service installed and running
□ Configuration verified and saved
□ Test email sent successfully
□ Logs reviewed
□ Monitoring in place
□ Documentation read

Setup complete! ✓


QUICK REFERENCE COMMANDS
========================
Check service status:
  sc query "SMTP to Graph Relay"

Start service:
  sc start "SMTP to Graph Relay"

Stop service:
  sc stop "SMTP to Graph Relay"

View service config:
  sc qc "SMTP to Graph Relay"

Check port 25:
  netstat -an | find "25"

Test SMTP:
  telnet localhost 25

Open logs:
  explorer [app-folder]\logs

Run modes:
  SMTP Service.exe              (Uses configured RunMode)
  SMTP Service.exe --console    (Force console + tray mode)
  SMTP Service.exe --tray       (Force tray-only mode)
